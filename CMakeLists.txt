cmake_minimum_required(VERSION 3.14)

# cmake only includes targets to do coverage
project(winasio-rs LANGUAGES)

find_program(cargo_exe cargo
REQUIRED
)

# extract test executable name
execute_process(
  COMMAND powershell.exe -Command "$env:RUSTFLAGS='-C instrument-coverage'; 
  (& \"${cargo_exe}\" test --test test --no-run *>&1) | ForEach-Object ToString"
  OUTPUT_VARIABLE _test_target
  COMMAND_ERROR_IS_FATAL ANY
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
)
message(STATUS "Using test exe ${_test_target}")
string(REGEX MATCH "target[\\].*\.exe" Target_Var "${_test_target}")
message(STATUS "Cmake target test ${Target_Var}")

# run tests with name contains "test"
add_custom_command(
  OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/MyPerf.profraw
  # remove old data
  COMMAND powershell.exe -Command "Remove-Item * -Include *.profraw"
  COMMAND ${Target_Var}
  COMMAND powershell.exe -Command "Get-ChildItem *.profraw | ForEach-Object {Rename-Item -Path $_.Name -NewName MyPerf.profraw}"
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
)

add_custom_target(cov_clean
  COMMAND powershell.exe -Command "Remove-Item * -Include *.profraw"
  COMMAND powershell.exe -Command "Remove-Item * -Include *.profdata"
  COMMAND powershell.exe -Command "Remove-Item * -Include *.xml"
  COMMAND powershell.exe -Command "Remove-Item * -Include coverage.*"
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
)

find_program(llvm_profdata_exe llvm-profdata
REQUIRED
)

add_custom_command(
  OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/winio.profdata
  COMMAND powershell.exe -Command "& \'${llvm_profdata_exe}\' merge -sparse MyPerf.profraw -o winio.profdata"
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
  DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/MyPerf.profraw
)

find_program(llvm_cov_exe llvm-cov
REQUIRED
)

# add_custom_command(
#   OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/coverage.txt
#   COMMAND ${llvm_cov_exe} show 
#   --ignore-filename-regex="\\\\.cargo\\\\registry" 
#   --instr-profile=winio.profdata 
#   --format text
#   --object "${Target_Var}" > report.txt
#   DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/winio.profdata
#   WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
# )

# TODO: coverage is generated by not readable by codecov

add_custom_command(
  OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/summary.txt
  COMMAND ${llvm_cov_exe} report 
  --ignore-filename-regex="\\\\.cargo\\\\registry" 
  --instr-profile=winio.profdata 
  --format text
  --object "${Target_Var}" > summary.txt
  COMMAND type summary.txt
  DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/winio.profdata
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
)

add_custom_command(
  OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/coverage.txt
  COMMAND ${llvm_cov_exe} show 
  --ignore-filename-regex="\\\\.cargo\\\\registry" 
  --instr-profile=winio.profdata 
  --format text
  --show-instantiations --show-line-counts-or-regions
  --Xdemangler=rustfilt
  --object "${Target_Var}" > coverage.txt
  DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/winio.profdata
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
)

add_custom_command(
  OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/coverage.json
  COMMAND ${llvm_cov_exe} export
  --ignore-filename-regex="\\\\.cargo\\\\registry" 
  --instr-profile=winio.profdata 
  --Xdemangler=rustfilt
  --object "${Target_Var}" > coverage.json
  DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/winio.profdata
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
)

add_custom_target(cov_all
  DEPENDS 
    ${CMAKE_CURRENT_SOURCE_DIR}/coverage.txt 
    ${CMAKE_CURRENT_SOURCE_DIR}/summary.txt
    ${CMAKE_CURRENT_SOURCE_DIR}/coverage.json
)

